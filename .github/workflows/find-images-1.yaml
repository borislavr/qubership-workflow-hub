name: Extract External Docker Images from Helm Charts

on:
  workflow_dispatch:
    inputs:
      organization:
        description: 'GitHub organization'
        required: true
        default: 'qubership'
      repositories:
        description: 'Comma-separated repository names (e.g. qubership-jaeger,qubership-logging-operator)'
        required: true
        default: 'qubership-jaeger,qubership-logging-operator'

jobs:
  extract:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install PyYAML PyGithub

      - name: Extract external images
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORGANIZATION: ${{ inputs.organization }}
          REPOSITORIES: ${{ inputs.repositories }}
        run: |
          python - << 'PYCODE'
          import os
          import base64
          import yaml
          import re
          from github import Github, GithubException

          g = Github(os.environ["GITHUB_TOKEN"])
          org = os.environ["ORGANIZATION"]
          repo_names = [r.strip() for r in os.environ["REPOSITORIES"].split(",") if r.strip()]

          def looks_like_image(s: str) -> bool:
              if not isinstance(s, str) or not s:
                  return False
              # Простое, но надёжное правило: есть / и (опционально) :
              return bool(re.search(r'^[a-zA-Z0-9][a-zA-Z0-9_./:-]*$', s)) and '/' in s

          def extract_images(data):
              images = []
              def recurse(obj):
                  if isinstance(obj, dict):
                      for v in obj.values():
                          recurse(v)
                  elif isinstance(obj, list):
                      for item in obj:
                          recurse(item)
                  elif isinstance(obj, str) and looks_like_image(obj):
                      images.append(obj)
              recurse(data)
              return images

          result = {}

          for repo_name in repo_names:
              full_name = f"{org}/{repo_name}"
              try:
                  repo = g.get_repo(full_name)
                  default_branch = repo.default_branch
                  tree = repo.get_git_tree(sha=default_branch, recursive=True)

                  external = []

                  for file in tree.tree:
                      if file.type != "blob" or not file.path.endswith("Chart.yaml"):
                          continue

                      chart_dir = os.path.dirname(file.path)
                      values_path = f"{chart_dir}/values.yaml" if chart_dir else "values.yaml"

                      try:
                          vf = repo.get_contents(values_path, ref=default_branch)
                          content = base64.b64decode(vf.content).decode("utf-8")
                          data = yaml.safe_load(content) or {}
                          imgs = extract_images(data)

                          for img in imgs:
                              # Исключаем всё, где есть "qubership" в имени образа
                              if "qubership" not in img.split(":", 1)[0].lower():
                                  external.append(img)
                      except GithubException as e:
                          if e.status != 404:
                              print(f"  └─ {values_path}: {e}")
                      except Exception as e:
                          print(f"  └─ Error parsing {values_path}: {e}")

                  if external:
                      result[repo_name] = sorted(list(set(external)))

              except Exception as e:
                  print(f"❌ Repo {repo_name}: {e}")

          # Сохраняем результат
          with open("external-docker-images.yaml", "w", encoding="utf-8") as f:
              yaml.dump(result, f, default_flow_style=False, sort_keys=False, indent=2)

          print("✅ Done. File: external-docker-images.yaml")
          PYCODE

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: external-docker-images
          path: external-docker-images.yaml

      # Опционально: коммитим файл обратно в репозиторий
      - name: Commit result (optional)
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add external-docker-images.yaml
          git commit -m "chore: update external docker images" || echo "No changes to commit"
          git push || echo "Nothing to push"
